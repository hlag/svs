/*
	Copyright (c) 2004-2008, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojoaddons.DndManager"]){dojo._hasResource["dojoaddons.DndManager"]=true;dojo.provide("dojoaddons.DndManager");dojo.require("dijit._Widget");dojo.require("dojo.dnd.common");dojo.declare("dojoaddons.DndManager",dijit._Widget,{map:{},isStyled:false,hasMouseOffset:false,hasBoundaries:false,hasClone:false,currentId:null,currentMouseOffset:{},currentBoundaries:{},currentOffset:0,currentAvatar:null,hasSortOrder:false,sortOrder:[],clonedMap:null,constructor:function(_1,_2){console.log("constructor");this.events=[dojo.connect(this.node,"ondragstart",this,"onSelectStart"),dojo.connect(this.node,"onselectstart",this,"onSelectStart"),dojo.connect(dojo.doc,"onmousemove",this,"onMouseMove"),dojo.connect(dojo.doc,"onmouseup",this,"onMouseUp")];return;if(!_2){_2={};}this.creator=_2.creator||null;this.skipForm=_2.skipForm;this.defaultCreator=dojo.dnd._defaultCreator(this.node);this.map={};this.current=null;this.containerState="";dojo.addClass(this.node,"dojoDndContainer");if(!(_2&&_2._skipStartup)){this.startup();}},startup:function(){console.log("startup");this.node=dojo.byId(this.id);this.getAllNodes().forEach(function(_3){if(!_3.id){_3.id=dojo.dnd.getUniqueId();}var _4=_3.getAttribute("dndType"),_5=_3.getAttribute("dndData");var _6={};_6.coords=dojo.coords(_3);_6.node=_3;var _7=dojo.query(".dojoDndHandle",_3)[0];_7.id=_3.id+"_handle";dojo.connect(_7,"onmousedown",this,"onMouseDown");_6.handle=_7;this.map[_3.id]=_6;},this);console.log(this);},resizeToLayer:function(){var c=dojo.coords(this.domNode.parentNode);dojo.style(this.domNode,{"position":"absolute","top":c.t+"px","left":c.l+"px","width":c.w+"px","height":c.h+"px"});},styleNodes:function(){if(this.isStyled){return;}console.log("styling");this._updateCoords();for(var id in this.map){var c=this.map[id].coords;dojo.style(this.map[id].node,{"position":"absolute","top":c.t+"px","left":c.l+"px","width":c.w+"px","zIndex":5});}this.isStyled=true;},_updateCoords:function(){if(this.isUpdated){return;}for(var id in this.map){this.map[id].coords=dojo.coords(this.map[id].node);}this.isUpdated=true;},cloneCoords:function(){if(!this.hasClone){this.clonedMap=dojo.clone(this.map);this.hasClone=true;}},postCreate:function(){console.log("postCreate");},getAllNodes:function(){return dojo.query(".dojoDndItem");},getMouseOffset:function(_c){if(this.hasMouseOffset){return this.currentMouseOffset;}console.log("getting offset");y=parseInt(this.map[this.currentId].node.style.top)-this.currentY;this.hasMouseOffset=true;this.currentMouseOffset=y;return y;},getBoundaries:function(){if(this.hasBoundaries){return this.currentBoundaries;}console.log("getting boundaries");var _d=this.sortOrder[0].top;var _e=this.sortOrder[this.sortOrder.length-1];if(this.currentId+"_avatar"==_e.id){bottomB=_e.top;}else{bottomB=_e.top+dojo.coords(_e.id).h;}var _f={top:_d,bottom:bottomB};this.hasBoundaries=true;this.currentBoundaries=_f;},drawAvatar:function(){if(!this.currentAvatar){var _10=dojo.doc.createElement("div");var _11=this.map[this.currentId].node.style;_10.id=this.currentId+"_avatar";_10.className="dndAvatar";dojo.style(_10,{"position":"absolute","top":_11.top,"left":_11.left,"width":_11.width,"height":this.map[this.currentId].coords.h+"px","zIndex":1});this.domNode.appendChild(_10);this.currentAvatar=_10;}},updateAvatar:function(y){if(this.isWorking){console.log(".. working ..");return;}this.isWorking=true;var _13;for(var i=0;i<this.sortOrder.length;i++){var _15=this.sortOrder[i].top;if(y>=_15){if(i+1==this.sortOrder.length){_13=i;}else{var end=this.sortOrder[i+1].top;if(y<=end){_13=i;}}}}if(this.sortOrder[_13].id==(this.currentId+"_avatar")){this.isWorking=false;return;}var _17=this.map[this.sortOrder[_13].id];var _18=_17.coords.h;var _19=this.sortOrder[_13].top+(_18/2);var _1a=y<_19?"upper":"lower";var _1b;for(var i=0;i<this.sortOrder.length;i++){if(this.sortOrder[i].id==(this.currentId+"_avatar")){_1b=i;}}var _1c;if(_13<_1b){_1c=_1a=="upper"?_13:_13+1;}else{_1c=_1a=="upper"?_13-1:_13+1;}if(_1c<0){_1c=0;}else{if(_1c==this.sortOrder.length){_1c--;}}if(_1c==_1b){this.isWorking=false;return;}this.itemsArePositioned=false;this.avatarIsPositioned=false;var _1d=_1c<_1b?"up":"down";console.log("replacing items...");console.log("avatar index: "+_1b);var _1e=dojo.byId(this.currentId+"_avatar");var _1f=this.map[this.sortOrder[_1c].id].node;if(_1d=="up"){console.log("up...");var _20=this.sortOrder[_1c].top;var _21=_20+dojo.coords(_1e).h;}else{console.log("down...");var _21=this.sortOrder[_1b].top;var _20=_21+dojo.coords(_1f).h;}var _22=this;dojo.anim(_1e,{"top":_20},100,dojo._defaultEasing,function(){_22.avatarIsPositioned=true;});dojo.anim(_1f,{"top":_21},100,dojo._defaultEasing,function(){_22.itemsArePositioned=true;});this.isUpdated=false;this.hasSortOrder=false;this.hasBoundaries=false;this.isWorking=false;},getOrder:function(){if(this.hasSortOrder){return;}var pos={};var _24=[];var t=dojo.coords(this.currentAvatar).t;_24.push(t);pos[t]=this.currentId+"_avatar";for(var id in this.map){if(id!=this.currentId){var t=this.map[id].coords.t;_24.push(t);pos[t]=id;}}var _27=function(a,b){return a-b;};var _2a=_24.sort(_27);var _2b=[];dojo.forEach(_24,function(top){var id=pos[top];_2b.push({id:id,top:top});});this.hasSortOrder=true;this.sortOrder=_2b;},endDragging:function(){dojo.anim(this.map[this.currentId].node,{"top":parseInt(this.currentAvatar.style.top),"opacity":1});var _2e=this;dojo.anim(this.currentAvatar,{"opacity":0},350,dojo._defaultEasing,function(){_2e.currentAvatar.parentNode.removeChild(_2e.currentAvatar);_2e.currentAvatar=null;});},cancelDragging:function(){console.log("dragging cancelled");var _2f=this;for(var id in this.clonedMap){console.log("moving item: "+id);dojo.anim(_2f.map[id].node,{"top":_2f.clonedMap[id].coords.t,"opacity":1});}dojo.anim(this.currentAvatar,{"opacity":0},350,dojo._defaultEasing,function(){_2f.currentAvatar.parentNode.removeChild(_2f.currentAvatar);_2f.currentAvatar=null;});},onMouseDown:function(evt){console.log("down");console.log(this);var _32=evt.target;for(_32=evt.target;!dojo.hasClass(_32,"dojoDndHandle");_32=_32.parentNode){}var id=_32.id.substr(0,_32.id.length-7);this.currentId=id;this.currentY=evt.clientY;this.isDragging=true;},onMouseUp:function(evt){if(this.isDragging&&this.draggingStarted){this.isDragging=false;this.hasMouseOffset=false;this.hasBoundaries=false;this.isUpdated=false;this.hasSortOrder=false;this.hasClone=false;this.isStyled=false;this.map[this.currentId].node.style.zIndex=5;if(this.avatarIsPositioned&&this.itemsArePositioned){this.endDragging();}else{this.cancelDragging();}}this.draggingStarted=false;},onMouseMove:function(evt){if(this.isDragging){this.draggingStarted=true;this.styleNodes();this.cloneCoords();this._updateCoords();this.drawAvatar();this.map[this.currentId].node.style.opacity=0.7;this.getOrder();var _36=this.getMouseOffset();this.getBoundaries();var _37=evt.clientY+_36;if(_37<this.currentBoundaries.top){_37=this.currentBoundaries.top;}if(_37>this.currentBoundaries.bottom){_37=this.currentBoundaries.bottom;}this.map[this.currentId].node.style.top=_37+"px";this.map[this.currentId].node.style.zIndex="500";this.updateAvatar(_37);}},onSelectStart:function(e){if(!this.skipForm||!dojo.dnd.isFormElement(e)){dojo.stopEvent(e);}}});}