/*
	Copyright (c) 2004-2008, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojoaddons.contentManagement.Manager"]){dojo._hasResource["dojoaddons.contentManagement.Manager"]=true;dojo.provide("dojoaddons.contentManagement.Manager");dojo.require("dojoaddons.contentManagement.DraggableContentItem");dojo.require("dijit._Widget");dojo.require("dojo.dnd.Source");dojo.declare("dojoaddons.contentManagement.Manager",dijit._Widget,{sourceNode:null,source:null,tinyCont:null,tinyId:null,tinyCont:"",lang:"",formId:"administratorMainForm",isFolderItem:false,postCreate:function(){dojo.requireLocalization("dijit","loading","de","zh-tw,ko,pt,he,ar,sk,zh,sl,tr,nb,de,ROOT,hu,th,it,ca,el,da,nl,ja,fr,pl,fi,ru,es,cs,sv,pt-pt");dojo.subscribe("/contentManagement/newItem",this,"newItem");dojo.subscribe("/contentManagement/itemDestroyed",this,"onItemDeletion");dojo.connect(window,"onresize",this,"delayedResize");dojo.connect(dojo.byId("save2"),"onclick",this,"saveData");dojo.addOnLoad(dojo.hitch(this,"getSource"));dojo.addOnLoad(dojo.hitch(this,"resizeContainer"));var _1={};if(!this.isFolderItem){var _2=dojo.byId("completelyTemporaryContentContainer_"+this.lang).value;_1={"contentManagement_TextItem_0_de":_2,"order":["contentManagement_TextItem_0_de"]};}var _3=this;dojo.addOnLoad(function(){_3.restoreData(dojo.toJson(_1));});var p=dojo.byId("preview2");if(p){p.onclick=dojo.hitch(this,"restoreByInput");}},getSource:function(){this.source=contentManagerSpace_Source;this.sourceNode=dojo.byId(this.id+"_Source");},delayedResize:function(){window.setTimeout(dojo.hitch(this,"resizeContainer"),0);},resizeContainer:function(){var _5=this.domNode.parentNode;var _6=dojo.coords(_5);var _7=dojo.query(".layerHead",_5)[0];var _8=dojo.coords(_7);var _9=_6.h-_8.h-29;this.domNode.style.height=_9+"px";},newItem:function(_a,_b,_c){if(!_c){dojo.publish("/contentManagement/contentChanged");}var _d=_b||{lang:this.lang};var _e=new dojoaddons.contentManagement[_a+"Item"](_d);this.sourceNode.appendChild(_e.domNode);this.source.clearItems();this.source.startup();},clearWorkspace:function(){var _f=this.getOrder();dojo.forEach(_f,function(_10){dijit.byId(this.idFromSimpleId(_10)).destroy();},this);},idFromSimpleId:function(_11){return "dojoaddons_"+_11.substr(0,_11.length-3);},onItemDeletion:function(id,_13){dojo.publish("/contentManagement/contentChanged");var _14=dijit.byId(id);if(_14&&_14.type=="Text"){var _15=tinyMCE.getInstanceById(_13);tinyMCE.remove(_15);_15.destroy();}this.source.delItem(id);},saveData:function(evt){dojo.stopEvent(evt);var _17=dojo.formToObject(this.formId);var _18=[];for(var id in this.source.map){var _1a=dijit.byId(id);if(_1a&&_1a.type=="Text"){var sId=_1a.simpleId;var _1c=tinyMCE.getInstanceById(sId);_17[sId]=_1c.getContent();}}_17.order=this.getOrder();console.info("This is the current form data:");console.dir(_17);console.info("The data as JSON:");var _1d=dojo.toJson(_17);console.log(_1d);alert("check console to see data.");return false;},getOrder:function(){var _1e=[];dojo.query(".draggableContentItem",this.domNode).forEach(function(_1f){_1e.push(dijit.byId(_1f.id).simpleId);});return _1e;},restoreByInput:function(evt){dojo.stopEvent(evt);var _21=prompt("Paste JSON data to restore:","");this.clearWorkspace();this.restoreData(_21);return false;},restoreData:function(_22){console.info("Restoring:");_22=dojo.fromJson(_22);console.log(_22);if(!_22.order){return;}var _23={};for(var id in _22){if(id.substr&&id.substr(0,17)=="contentManagement"){console.log("item found: "+id);var _25=id.split("_");var _26=_25[1].substr(0,_25[1].length-4);var _27=_25[2];var _28=_25[3];var add=_25[4]||false;var _2a="contentManagement"+"_"+_25[1]+"_"+_27+"_"+_28;if(!_23[_2a]){_23[_2a]={type:_26,lang:_28};}if(add){if(_26=="Teaser"){if(!_23[_2a].add){_23[_2a].add=[];}if(!_23[_2a].add[add]){_23[_2a].add[add]={};}if(_25[5]){_23[_2a].add[add].rec=_22[id];}else{_23[_2a].add[add].data=_22[id];}}else{if(!_23[_2a].add){_23[_2a].add={};}_23[_2a].add[add]=_22[id];}}else{_23[_2a].data=_22[id];}}}dojo.forEach(_22.order,function(id){console.log("calling "+id);this.newItem(_23[id].type,_23[id],true);},this);},onDndDrop:function(_2c,_2d,_2e,_2f){console.log(this.onDndDrop.arguments);console.log("dnd ended");if(this.tinyCont){console.log("removing instance");tinyMCE.remove(this.tinyInst);this.tinyInst.destroy();dojo.byId(this.tinyId).style.display="block";var c=this.tinyCont;console.log("removing old editor from DOM");var _31=dojo.query("span#"+this.tinyId+"_parent")[0];_31.parentNode.removeChild(_31);console.log("adding new editor...");var ed=new tinymce.Editor(this.tinyId,{language:tools.language,theme:"advanced",plugins:"safari,pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,inlinepopups,insertdatetime,preview,media,searchreplace,print,contextmenu,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras,template",theme_advanced_buttons2_add:"insertdate,inserttime,ibrowser",theme_advanced_buttons2_add_before:"search,replace,cut,copy,paste,pastetext,separator,pasteword",theme_advanced_buttons3_add_before:"tablecontrols",theme_advanced_buttons3_add:"fullscreen,media",theme_advanced_buttons4:"insertlayer,moveforward,movebackward,absolute",theme_advanced_disable:"strikethrough,help,sub,sup,underline",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"bottom",theme_advanced_resizing:true,theme_advanced_resize_horizontal:false,template_external_list_url:"lists/template_list.js",external_link_list_url:"link_list.js",external_image_list_url:"lists/image_list.js",media_external_list_url:"lists/media_list.js",file_browser_callback:"kfm_for_tiny_mce",init_instance_callback:dojo.hitch(this,function(){tinyMCE.editors[this.tinyId].setContent(c);}),content_css:"../css/cms_global.css",extended_valid_elements:"hr[class|width|size|noshade],font[face|size|color|style],span[class|align|style]",relative_urls:false,absolute_urls:false,convert_urls:false,remove_linebreaks:true,accessibility_focus:false,nowrap:false});tinyMCE.add(ed);console.log(ed);ed.init();this.tinyCont=null;}},onDndStart:function(src,_34){console.log("dnd started");console.log(this.onDndStart.arguments);var _35=_34[0];if(dojo.hasClass(_35,"tinyMCEItem")){console.log("tiny pane...");var id=dojo.query("textarea",_35.id)[0].id;var _37=tinyMCE.getInstanceById(id);if(_37){var _38=_37.getContent();console.log(_38);this.tinyCont=_38;this.tinyId=id;this.tinyInst=_37;GlobalInst=_37;}}}});}