/*
	Copyright (c) 2004-2008, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojoaddons.usermanagement.UserManager"]){dojo._hasResource["dojoaddons.usermanagement.UserManager"]=true;dojo.provide("dojoaddons.usermanagement.UserManager");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dojoaddons.usermanagement.UserPane");dojo.require("dojoaddons.ContextMenu");dojo.require("dojox.widget.Toaster");dojo.declare("dojoaddons.usermanagement.UserManager",[dijit._Widget,dijit._Templated],{dataSource:"",dataStore:null,groups:[],workingId:0,isWorking:false,userCount:0,arrayOfAllUsers:[],clipBoard:[],_copyKey:"",templateString:"<div dojoAttachPoint=\"containerNode\" class=\"UserManagerContainer\" ></div>",postCreate:function(){dojo._loadUri("/common/Modules/Rechteverwaltung/languages/"+tools.language+".js");this.domNode.style.overflow="auto";if(this.dataSource===""){console.error("No data source provided!");return;}dojo.extend(dojo.data.ItemFileWriteStore,{_saveEverything:function(_1,_2,_3){var _4="data="+encodeURIComponent(_3);dojo.rawXhrPost({handleAs:"text",url:"/common/Modules/Rechteverwaltung/Classes/data_handler.php",postData:_4,timeout:5000,onLoad:function(_5,_6){if(_5=="success"){_1();}else{_2();}},onError:_2});_1();}});this.dataStore=new dojo.data.ItemFileWriteStore({url:this.dataSource});this.getData();this._copyKey=navigator.appVersion.indexOf("Macintosh")<0?"ctrlKey":"metaKey";this.dialog=new dojoaddons.ShadowDialog();dojo.subscribe("/usermanagement/deleteUser",this,"deleteUser");dojo.subscribe("/usermanagement/editUser",this,"editUser");dojo.subscribe("/usermanagement/newUser",this,"newUser");dojo.subscribe("/usermanagement/deleteGroup",this,"deleteGroup");dojo.subscribe("/usermanagement/editGroup",this,"editGroup");dojo.subscribe("/usermanagement/newGroup",this,"newGroup");dojo.subscribe("/usermanagement/contextEditUser",this,"editUser");dojo.subscribe("/usermanagement/contextDeleteUser",this,"onContextDelete");dojo.subscribe("/usermanagement/contextAddUser",this,"addUser");dojo.subscribe("/usermanagement/contextMoveUser",this,"moveUserAround");dojo.subscribe("/usermanagement/contextRemoveUser",this,"removeUserFromGroup");dojo.subscribe("/usermanagement/userClicked",this,"onUserClick");dojo.subscribe("/usermanagement/markUser",this,"markUser");dojo.subscribe("/usermanagement/unmarkUser",this,"unmarkUser");dojo.subscribe("/usermanagement/paneOpened",this,"updateMarking");dojo.subscribe("/usermanagement/doMove",this,"doMove");dojo.subscribe("/usermanagement/doAdd",this,"addUserToGroup");dojo.subscribe("/usermanagement/cancelDialog",this,function(){this.dialog.hide();});dojo.subscribe("/usermanagement/triggerUpdate",this,"saveDataStore");dojo.subscribe("/usermanagement/handleContext",this,"handleContext");dojo.connect(this.dataStore,"onDelete",function(_7){dojo.publish("/usermanagement/itemDeleted",[_7]);});var _8=dojo.doc.createElement("div");_8.id="usermanagementToaster";dojo.body().appendChild(_8);this.toaster=new dojox.widget.Toaster({messageTopic:"toasterMessage"},_8);dojo.connect(window,"resize",dojo.hitch(this,"resizeToMidRow"));window.setTimeout(dojo.hitch(this,"resizeToMidRow"),500);if(dojo.isIE){dojo.connect(this.domNode,"onselectstart",function(_9){dojo.stopEvent(_9);});}if(!this.contextMenu){this.contextMenu=new dojoaddons.ContextMenu({id:"userManagementContextMenu"});this.contextMenu.addItem(tools.lang.get("editUser"),"/usermanagement/contextEditUser",[],"edit");this.contextMenu.addItem(tools.lang.get("deleteUser"),"/usermanagement/contextDeleteUser",[],"delete");this.contextMenu.addItem(tools.lang.get("addUserToGroup"),"/usermanagement/contextAddUser",[],"add");this.contextMenu.addItem(tools.lang.get("moveUserToGroup"),"/usermanagement/contextMoveUser",[],"move");this.contextMenu.addItem(tools.lang.get("removeUserFromGroup"),"/usermanagement/contextRemoveUser",[],"remove");}},getData:function(){var _a=this;this.dataStore.fetch({onBegin:function(){},onItem:function(_b){if(_b.type=="group"){_a.groups.push(_b);}else{_a.arrayOfAllUsers.push(_b);}},onComplete:function(){_a.renderPanes();}});},renderPanes:function(){var a,_d=this;a=new dojoaddons.usermanagement.AllUsersPane({dataStore:this.dataStore,groupName:tools.lang.get("allUsers"),groupId:"all",users:this.arrayOfAllUsers,open:false,id:"UserPane_all"},dojo.doc.createElement("div"));this.domNode.appendChild(a.domNode);a=new dojoaddons.usermanagement.LostUsersPane({dataStore:this.dataStore,groupName:tools.lang.get("lostUsers"),groupId:"lost",users:[],open:false,id:"UserPane_lost"},dojo.doc.createElement("div"));this.domNode.appendChild(a.domNode);this.groups.forEach(function(_e){a=new dojoaddons.usermanagement.UserPane({dataStore:_d.dataStore,groupName:_e.name,groupId:_e.id[0],users:_e.children,open:false,id:"UserPane_"+_e.id[0]},dojo.doc.createElement("div"));_d.domNode.appendChild(a.domNode);});var _f=dojo.doc.createElement("div");_f.id="UserManagerBottomShadow";this.domNode.appendChild(_f);},renderGroupSelect:function(){var _10="<select id=\"usermanagementGroupSelect\">";dojo.forEach(this.groups,function(_11){_10+="<option value=\""+_11.id[0]+"\">"+_11.name+"</option>";});_10+="</select>";return _10;},resizeToMidRow:function(){var _12=dojo.coords("MiddlePanel");var _13=dojo.coords(this.domNode).t;dojo.style(this.domNode,{"height":(_12.h-_13-2)+"px"});},onUserClick:function(id,evt){var _16=this.getKeyState(evt);if(_16=="copy"){if(!this.clipboardHasUser(id)){this.addUserToClipboard(id);}else{this.removeUserFromClipboard(id);}}else{if(_16=="shift"){for(var _17=evt.target;!dojo.hasClass(_17,"dijitTitlePaneContentInner");_17=_17.parentNode){}var _18=dojo.query(".marked",_17);if(!_18.length){return;}var _19=_18[0];this.clearClipboard();var _1a=false;var _1b=false;dojo.query(".userRow",_17).forEach(function(row){if(!_1b){var _1d=this.parseIdFromClass(row.className);if(row==_19){_1a=true;}if(_1d==id){_1b=true;}if(_1a){if(!this.clipboardHasUser(_1d)){this.addUserToClipboard(_1d);}}}},this);}else{this.clearClipboard();this.addUserToClipboard(id);}}},parseIdFromClass:function(_1e){_1e=_1e.split(" ");var id="";dojo.forEach(_1e,function(_20){if(_20.substr(0,5)=="user_"){id=_20.substr(5);}});return parseInt(id,10);},getKeyState:function(evt){if(evt.shiftKey){return "shift";}if(evt[this._copyKey]){return "copy";}return "";},addUserToClipboard:function(id){this.clipBoard.push(id);dojo.publish("/usermanagement/markUser",[id]);},clipboardHasUser:function(id){return dojo.some(this.clipBoard,function(_24){return _24==id;});},removeUserFromClipboard:function(id){var _26=[];dojo.forEach(this.clipBoard,function(_27){if(id!==_27){_26.push(_27);}},this);this.clipBoard=_26;dojo.publish("/usermanagement/unmarkUser",[id]);},clearClipboard:function(){dojo.forEach(this.clipBoard,function(id){dojo.publish("/usermanagement/unmarkUser",[id]);},this);this.clipBoard=[];},markUser:function(id){dojo.query(".user_"+id,this.domNode).forEach(function(_2a){dojo.addClass(_2a,"marked");});},unmarkUser:function(id){dojo.query(".user_"+id,this.domNode).forEach(function(_2c){dojo.removeClass(_2c,"marked");});},updateMarking:function(){dojo.forEach(this.clipBoard,function(id){this.markUser(id);},this);},onContextDelete:function(){var _2e=this.clipBoard.length;tools.confirm({title:tools.lang.get("confirmContextDeletionTitle"),content:dojo.string.substitute(tools.lang.get("confirmContextDeletionContent"),{counter:_2e}),callback:dojo.hitch(this,"doContextDeletion")});},doContextDeletion:function(){var _2f=dojo.clone(this.clipBoard);this.globalSavePrevent=true;for(var c=0;c<_2f.length;c++){this.workingId=_2f[c];if(c==_2f.length-1){this.globalSavePrevent=false;}this.doUserDeletion();}},deleteUser:function(id){this.workingId=id;var _32=dojo.query(".user_"+id+" .userName")[0].innerHTML;tools.confirm({title:tools.lang.get("confirmUserDeletionTitle"),content:dojo.string.substitute(tools.lang.get("confirmUserDeletionContent"),{userName:_32}),iconClass:"error",callback:dojo.hitch(this,"doUserDeletion")});},editUser:function(id){if(typeof (id)!="number"){id=this.clipBoard[0];}dojo.byId("RightPanel").innerHTML="editing user #"+id;},newUser:function(){dojo.byId("RightPanel").innerHTML="new user";},deleteGroup:function(id){this.workingId=id;var _35=dojo.query("#UserPane_"+id+" .dijitTitlePaneTextNode")[0].innerHTML;tools.confirm({title:tools.lang.get("confirmGroupDeletionTitle"),content:dojo.string.substitute(tools.lang.get("confirmGroupDeletionContent"),{groupName:_35}),callback:dojo.hitch(this,"doGroupDeletion")});},editGroup:function(id){dojo.byId("RightPanel").innerHTML="editing group #"+id;},newGroup:function(){dojo.byId("RightPanel").innerHTML="new group";},saveDataStore:function(_37,_38){if(_38){return;}this.dataStore.save({onComplete:function(){dojo.publish("toasterMessage",[{message:tools.lang.get("saveSuccess"),type:"message"}]);},onError:function(){dojo.publish("toasterMessage",[{message:tools.lang.get("saveFailed"),type:"error"}]);this.dataStore.revert();dojo.publish("/usermanagement/triggerUpdate",["global",true]);}});},doUserDeletion:function(){if(this.isWorking){return;}this.isWorking=true;dojo.query(".user_"+this.workingId).forEach(function(_39){_39.parentNode.removeChild(_39);});if(this.clipboardHasUser(this.workingId)){this.removeUserFromClipboard(this.workingId);}this.deleteItemFromStore(this.workingId);this.isWorking=false;},doGroupDeletion:function(){if(this.isWorking){return;}this.isWorking=true;var _3a=dijit.byId("UserPane_"+this.workingId);_3a.unsubscribe();_3a.destroy();this.deleteItemFromStore(this.workingId);this.isWorking=false;},doMove:function(){var _3b=parseInt(dojo.byId("usermanagementGroupSelect").value,10);this.dialog.hide();this.removeUserFromGroup(_3b,true);this.addUserToGroup(_3b,false);},moveUserAround:function(){this.dialog.titleNode.innerHTML=tools.lang.get("moveUsersDialogTitle");var _3c="<div class=\"dialogButtonBar\"><button onclick=\"dojo.publish('/usermanagement/doMove');\" class=\"ShadowDialogSaveButton\">"+tools.lang.get("genericConfirmOk")+"</button><button onclick=\"dojo.publish('/usermanagement/cancelDialog');\" class=\"ShadowDialogCancelButton\">"+tools.lang.get("genericConfirmCancel")+"</button></div>";var _3d=dojo.string.substitute(tools.lang.get("chooseGroupToMoveTo"),{groupSelect:this.renderGroupSelect()});this.dialog.setContent(_3d+_3c);this.dialog.show();},addUser:function(){this.dialog.titleNode.innerHTML=tools.lang.get("addUsersDialogTitle");var _3e="<div class=\"dialogButtonBar\"><button onclick=\"dojo.publish('/usermanagement/doAdd');\" class=\"ShadowDialogSaveButton\">"+tools.lang.get("genericConfirmOk")+"</button><button onclick=\"dojo.publish('/usermanagement/cancelDialog');\" class=\"ShadowDialogCancelButton\">"+tools.lang.get("genericConfirmCancel")+"</button></div>";var _3f=dojo.string.substitute(tools.lang.get("chooseGroupToAddTo"),{groupSelect:this.renderGroupSelect()});this.dialog.setContent(_3f+_3e);this.dialog.show();},addUserToGroup:function(_40,_41){if(this.isWorking){return;}this.isWorking=true;if(typeof (_40)!="number"){_40=parseInt(dojo.byId("usermanagementGroupSelect").value,10);this.dialog.hide();}var _42=this;this.itemCounter=this.clipBoard.length;this.dataStore.fetchItemByIdentity({identity:_40,onItem:function(_43){var _44=_42.dataStore.getValues(_43,"children");dojo.forEach(_42.clipBoard,function(id){if(!dojo.some(_44,function(_46){return _46.id[0]==id;})){console.log("group #"+_40+" doesnt have user #"+id+", adding it...");this.dataStore.fetchItemByIdentity({identity:id,onItem:function(_47){_44.push(_47);_42.itemCounter--;if(_42.itemCounter===0){_42.dataStore.setValues(_43,"children",_44);dojo.publish("/usermanagement/triggerUpdate",[_40]);if(!_41){_42.clearClipboard();}}}});}else{console.log("group #"+_40+" already has user #"+id+", not adding it.");_42.itemCounter--;if(_42.itemCounter===0){_42.dataStore.setValues(_43,"children",_44);dojo.publish("/usermanagement/triggerUpdate",[_40]);if(!_41){_42.clearClipboard();}}}},_42);}});this.isWorking=false;},removeUserFromGroup:function(_48){if(this.isWorking){return;}this.isWorking=true;var _49=parseInt(this.currentContextGroupId,10);var _4a=this;this.dataStore.fetchItemByIdentity({identity:_49,onItem:function(_4b){var _4c=_4a.dataStore.getValues(_4b,"children");var _4d=[];dojo.forEach(_4c,function(_4e){var _4f=_4e.id[0];if(!this.clipboardHasUser(_4f)){_4d.push(_4e);}else{dojo.query("#UserPane_"+_49+" .user_"+_4f).forEach(function(_50){_50.parentNode.removeChild(_50);});}},_4a);_4a.dataStore.setValues(_4b,"children",_4d);var _51=[_49];if(_48){_51.push(true);}dojo.publish("/usermanagement/triggerUpdate",_51);if(!_48){_4a.clearClipboard();}}});this.isWorking=false;},deleteItemFromStore:function(id){this.dataStore.fetchItemByIdentity({identity:id,scope:this,onItem:function(_53){this.dataStore.deleteItem(_53);if(!this.globalSavePrevent){this.saveDataStore();}}});},handleContext:function(id,evt){dojo.stopEvent(evt);for(var _56=evt.target;!dojo.hasClass(_56,"dijitTitlePane");_56=_56.parentNode){}var _57=_56.id.substr(9);this.currentContextGroupId=_57;var _58=dijit.byId(_56.id);this.workingId=id;this.contextMenu.clearTimer();if(!this.clipboardHasUser(id)){this.clearClipboard();this.addUserToClipboard(id);}var _59=this.contextMenu.domNode;if(!this.contextMenuHeight){this.contextMenuHeight=this.contextMenu.getHeight();}var _5a=this.contextMenuHeight;var _5b=250;var _5c=evt.clientY-_5a;dojo.style(_59,{"top":(evt.clientY+2)+"px","left":(evt.clientX-2)+"px","height":"0px","width":"100px","display":"block","opacity":1,"zIndex":20});this.contextMenu.setTitle("Marked Users: "+this.clipBoard.length);this.contextMenu.toggleItem("edit",this.clipBoard.length<=1);this.contextMenu.toggleItem("remove",_58.type!="dynamic");this.contextMenu.toggleItem("move",_58.type!="dynamic");dojo.anim(_59,{"height":_5a,"width":_5b,"top":_5c},200);}});}