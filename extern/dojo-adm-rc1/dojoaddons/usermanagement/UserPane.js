/*
	Copyright (c) 2004-2008, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojoaddons.usermanagement.UserPane"]){dojo._hasResource["dojoaddons.usermanagement.UserPane"]=true;dojo.provide("dojoaddons.usermanagement.UserPane");dojo.require("dijit.TitlePane");dojo.declare("dojoaddons.usermanagement.UserPane",[dijit.TitlePane],{hasContent:false,groupId:0,groupName:"",users:[],childrenCount:0,dataStore:null,type:"generic",postCreate:function(){this.resetTitle();if(!this.open){this.hideNode.style.display=this.wipeNode.style.display="none";}if(this.type=="generic"){this.addActionNodes();}this._setCss();dojo.setSelectable(this.titleNode,false);this.inherited(arguments);dijit.setWaiState(this.containerNode,"labelledby",this.titleNode.id);dijit.setWaiState(this.focusNode,"haspopup","true");var _1=this.hideNode,_2=this.wipeNode;this._wipeIn=dojo.fx.wipeIn({node:this.wipeNode,duration:this.duration,beforeBegin:function(){_1.style.display="";}});this._wipeOut=dojo.fx.wipeOut({node:this.wipeNode,duration:this.duration,onEnd:function(){_1.style.display="none";}});dojo.addClass(this.domNode,"UserPane");this.setContent("loading...");this.subscriptions=[dojo.subscribe("/usermanagement/itemDeleted",dojo.hitch(this,"_onItemDeletion")),dojo.subscribe("/usermanagement/triggerUpdate",dojo.hitch(this,"onUpdateTrigger"))];},unsubscribe:function(){dojo.forEach(this.subscriptions,function(_3){dojo.unsubscribe(_3);});},addActionNodes:function(){var id=this.groupId;var d=dojo.doc.createElement("div");dojo.connect(d,"onclick",function(_6){dojo.stopEvent(_6);dojo.publish("/usermanagement/deleteGroup",[id]);});d.className="groupAction groupDeleteAction";d.innerHTML="<span>X</span>";this.titleBarNode.appendChild(d);var e=dojo.doc.createElement("div");dojo.connect(e,"onclick",function(_8){dojo.stopEvent(_8);dojo.publish("/usermanagement/editGroup",[id]);});e.className="groupAction groupEditAction";e.innerHTML="<span>E</span>";this.titleBarNode.appendChild(e);},onUpdateTrigger:function(_9){if(_9==this.groupId||_9=="global"){this.updateData();}},updateData:function(){console.log("Group \""+this.groupName+"\" updating.");var _a=this;var _b=[];this.dataStore.fetch({onBegin:function(){},query:{id:_a.groupId},onItem:function(_c){if(_c.children){_b=_c.children;}},onComplete:function(){_a.users=_b;_a.resetTitle();}});},toggle:function(){dojo.forEach([this._wipeIn,this._wipeOut],function(_d){if(_d.status()=="playing"){_d.stop();}});this[this.open?"_wipeOut":"_wipeIn"].play();this.open=!this.open;this._loadCheck();this._setCss();dojo.publish("/usermanagement/paneOpened");},_loadCheck:function(_e){var _f=this._isShown();if(!this.hasContent){this.hasContent=true;this.renderPaneContent();}},resetTitle:function(){this.childrenCount=this.users.length;this.title=this.groupName+"<span class=\"userCount\"><span class=\"userCountInner\">"+this.childrenCount+"</span></span>";this.setTitle(this.title);dojo.toggleClass(this.domNode,"emptyGroup",this.childrenCount===0);},_setCss:function(){var _10=["dijitClosed","dijitOpen"];var _11=this.open;var _12=this.titleBarNode||this.focusNode;dojo.removeClass(_12,_10[!_11+0]);if(!dojo.hasClass(_12,_10[_11+0])){_12.className+=" "+_10[_11+0];}this.arrowNodeInner.innerHTML=this.open?"-":"+";},renderPaneContent:function(){var _13=this;var b=dojo.doc.createElement("div");var _15=dojo.doc.createElement("div");_15.className="emptyGroupIndicator";_15.innerHTML=tools.lang.get("noUsers");b.appendChild(_15);dojo.forEach(this.users,function(_16){b.appendChild(_13._renderUserRow(_16));});this.setContent(b);},_onItemDeletion:function(_17){if(this.hasUser(_17.id[0])){this.childrenCount--;this.updateData();}},hasUser:function(_18){var _19=this.users;return dojo.some(_19,function(_1a){return _1a.id[0]==_18;});},_renderUserRow:function(_1b){var row=dojo.doc.createElement("div");row.className="userRow user_"+_1b.id[0];dojo.connect(row,"onmouseover",function(){dojo.addClass(row,"highlighted");});dojo.connect(row,"onmouseout",function(){dojo.removeClass(row,"highlighted");});dojo.connect(row,"onclick",function(evt){dojo.publish("/usermanagement/userClicked",[_1b.id[0],evt]);});dojo.connect(row,"oncontextmenu",function(evt){dojo.publish("/usermanagement/handleContext",[_1b.id[0],evt]);});dojo.connect(row,"ondblclick",function(evt){dojo.publish("/usermanagement/editUser",[_1b.id[0],evt]);});row.innerHTML="<div class=\"userName\"><span class=\"userLastName\">"+_1b.name+"</span><span class=\"userNameSeperator\">, </span><span class=\"userFirstName\">"+_1b.firstname+"</span></div><div class=\"userDeleteAction userAction\" onclick=\"dojo.publish('/usermanagement/deleteUser',["+_1b.id[0]+"])\"><span>X</span></div><div class=\"userEditAction userAction\" onclick=\"dojo.publish('/usermanagement/editUser',["+_1b.id[0]+"])\"><span>E</span></div>";return row;}});dojo.declare("dojoaddons.usermanagement.AllUsersPane",[dojoaddons.usermanagement.UserPane],{type:"dynamic",updateData:function(){var _20=this;var _21=[];this.dataStore.fetch({onBegin:function(){},query:{type:"user"},onItem:function(_22){_21.push(_22);},onComplete:function(){_20.users=_21;_20.resetTitle();}});}});dojo.declare("dojoaddons.usermanagement.LostUsersPane",[dojoaddons.usermanagement.UserPane],{type:"dynamic",postCreate:function(){this.checkForLostUsers();if(!this.open){this.hideNode.style.display=this.wipeNode.style.display="none";}if(this.type=="generic"){this.addActionNodes();}this._setCss();dojo.setSelectable(this.titleNode,false);this.inherited(arguments);dijit.setWaiState(this.containerNode,"labelledby",this.titleNode.id);dijit.setWaiState(this.focusNode,"haspopup","true");var _23=this.hideNode,_24=this.wipeNode;this._wipeIn=dojo.fx.wipeIn({node:this.wipeNode,duration:this.duration,beforeBegin:function(){_23.style.display="";}});this._wipeOut=dojo.fx.wipeOut({node:this.wipeNode,duration:this.duration,onEnd:function(){_23.style.display="none";}});dojo.addClass(this.domNode,"UserPane");this.setContent("loading...");dojo.subscribe("/usermanagement/itemDeleted",dojo.hitch(this,"_onItemDeletion"));dojo.subscribe("/usermanagement/triggerUpdate",dojo.hitch(this,"updateData"));},updateData:function(){this.checkForLostUsers();},checkForLostUsers:function(){var _25=this;var _26=[];var _27=[];this.dataStore.fetch({onBegin:function(){},onItem:function(_28){if(_28.type=="group"){_27.push(_28);}else{_26.push(_28);}},onComplete:function(){_25.allUsers=_26;_25.allGroups=_27;_25.__getLostUsers();}});},__getLostUsers:function(){var _29={};var _2a=[];dojo.forEach(this.allGroups,function(_2b){dojo.forEach(_2b.children,function(_2c){if(!_29[_2c.id[0]]){_29[_2c.id[0]]=_2c.id[0];}});});dojo.forEach(this.allUsers,function(_2d){if(!_29[_2d.id[0]]){_2a.push(_2d);}});this.users=_2a;this.childrenCount=this.users.length;this.setContent("");this.renderPaneContent();this.resetTitle();},_onItemDeletion:function(_2e){if(this.hasUser(_2e.id[0])){this.childrenCount--;this.resetTitle();}this.updateData();}});}